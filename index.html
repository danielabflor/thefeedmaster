<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Feed Master</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            transition: box-shadow 0.3s ease;
        }

        .game-container.critical-time {
            animation: criticalPulse 0.5s infinite;
            box-shadow: inset 0 0 50px rgba(255, 0, 0, 0.3);
        }

        @keyframes criticalPulse {
            0% { 
                box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.4),
                           0 0 40px rgba(255, 0, 0, 0.3);
            }
            50% { 
                box-shadow: inset 0 0 60px rgba(255, 0, 0, 0.7),
                           0 0 80px rgba(255, 0, 0, 0.6);
            }
            100% { 
                box-shadow: inset 0 0 30px rgba(255, 0, 0, 0.4),
                           0 0 40px rgba(255, 0, 0, 0.3);
            }
        }

        /* Header Section */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .game-title {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .level-display {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 10px;
        }

        /* Level Info - Now between header and control bar */
        .level-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(31, 38, 135, 0.2);
        }

        /* Control Bar - Timer and Polarization */
        .control-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            min-width: 120px;
        }

        .timer.critical {
            background: rgba(255, 0, 0, 0.3);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .polarization-container {
            flex: 1;
            max-width: 500px;
        }

        .polarization-label {
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .polarization-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .polarization-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #FFC107 50%, #F44336 100%);
            border-radius: 15px;
            transition: width 0.3s ease;
            position: relative;
        }

        .polarization-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        /* Main Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* Statistics Panel - New bottom layout */
        .statistics-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .stats-section h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
            text-align: center;
        }

        /* User Panel */
        .user-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .user-interests {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .interest-tag {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .engagement-bar-container {
            margin-top: 10px;
        }

        .engagement-label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .engagement-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .engagement-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Content Panel */
        .content-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .content-tag {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .content-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .content-stats {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-promote-all {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
        }

        .btn-discard {
            background: linear-gradient(45deg, #666, #999);
        }

        .user-specific-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .bias-alerts {
            margin-top: 15px;
        }

        .bias-alert {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .bias-alert.warning {
            background: rgba(255, 0, 0, 0.2);
            border-color: rgba(255, 0, 0, 0.5);
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 16px 64px rgba(31, 38, 135, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal h2 {
            margin-bottom: 20px;
            font-size: 2em;
        }

        .modal p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1em;
            margin: 10px;
            min-width: 150px;
        }

        /* Floating Elements */
        .discard-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 15px 20px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header-stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .polarization-container {
                margin: 0;
                max-width: 100%;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        /* Content category colors */
        .tag-sports { background: #4CAF50; }
        .tag-entertainment { background: #FF9800; }
        .tag-lifestyle { background: #E91E63; }
        .tag-health { background: #2196F3; }
        .tag-technology { background: #9C27B0; }
        .tag-news { background: #607D8B; }
        .tag-politics { background: #F44336; }
        .tag-debate { background: #FF5722; }
        .tag-fakenews { background: #B71C1C; animation: pulse 2s infinite; }

        /* Interest tag colors matching content categories */
        .interest-sports { background: #4CAF50; }
        .interest-entertainment { background: #FF9800; }
        .interest-lifestyle { background: #E91E63; }
        .interest-health { background: #2196F3; }
        .interest-technology { background: #9C27B0; }
        .interest-news { background: #607D8B; }
        .interest-politics { background: #F44336; }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="game-container" id="game-container">
        <!-- Header Section -->
        <div class="header">
            <h1 class="game-title">🎮 The Feed Master</h1>
        </div>

        <!-- Level Info - MOVED HERE (between header and control bar) -->
        <div class="level-info">
            <div class="level-display" id="header-level" style="display: inline-block; margin-bottom: 10px;">Level 1</div>
            <h3 id="level-title">Level 1: Basic Concept</h3>
            <p id="level-description">Learn how content algorithms work by managing one user's feed.</p>
        </div>

        <!-- Control Bar -->
        <div class="control-bar">
            <div class="timer" id="timer">⏰ 0:10</div>
            
            <div class="polarization-container">
                <div class="polarization-label">🌍 Global Polarization</div>
                <div class="polarization-bar">
                    <div class="polarization-fill" id="polarization-fill" style="width: 0%"></div>
                    <div class="polarization-text" id="polarization-text">0%</div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard">
            <!-- Users Panel -->
            <div class="panel">
                <h3 class="panel-title">👥 Users</h3>
                <div class="user-list" id="user-list">
                    <!-- Users will be populated here -->
                </div>
            </div>

            <!-- Content Panel -->
            <div class="panel">
                <h3 class="panel-title">📱 Content Queue</h3>
                <div id="queue-counter" style="text-align: center; background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: bold;">
                    Content Remaining: <span id="content-remaining">0</span> / <span id="content-total">0</span>
                </div>
                <div id="content-container">
                    <!-- Content cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Statistics Panel - Bottom -->
        <div class="statistics-panel">
            <h3 style="text-align: center; margin-bottom: 20px; font-size: 1.5em;">📊 Detailed Statistics</h3>
            <div class="stats-container">
                <div class="stats-section">
                    <h4>📈 Content Metrics</h4>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="content-processed">0</div>
                            <div class="stat-label">Processed</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="content-discarded">0</div>
                            <div class="stat-label">Discarded</div>
                        </div>
                    </div>
                </div>

                <div class="stats-section">
                    <h4>🚨 Bias Alerts</h4>
                    <div id="bias-alerts-container" style="min-height: 80px;">
                        <!-- Bias alerts will appear here -->
                    </div>
                </div>

                <div class="stats-section">
                    <h4>📋 Round Summary</h4>
                    <div id="round-summary" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; font-size: 0.9em; max-height: 150px; overflow-y: auto;">
                        Game in progress...
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Elements -->
        <div class="discard-counter">
            🗑️ Discarded: <span id="discard-count">0</span>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="modal" id="tutorial-modal">
        <div class="modal-content">
            <div id="tutorial-page-1">
                <h2>🎮 Welcome to The Feed Master!</h2>
                <h3>🎯 Your Mission</h3>
                <p style="font-size: 1.1em; line-height: 1.8;">You are the <strong>algorithm</strong> behind a social media platform. Your job is to decide what content each user sees in their feed.</p>
                
                <p style="font-size: 1.1em; line-height: 1.8; margin-top: 15px;">Your goal: <strong>Get ALL users to 100% engagement</strong> before running out of content, while keeping the platform stable.</p>
                
                <p style="margin-top: 20px; opacity: 0.9;">Every decision you make shapes what users believe, how they think, and how divided society becomes.</p>
                
                <button class="btn btn-large" onclick="showTutorialPage(2)">Next: Game Mechanics ➡️</button>
            </div>

            <div id="tutorial-page-2" class="hidden">
                <h2>⚙️ Game Mechanics</h2>
                
                <div style="text-align: left; margin: 20px 0;">
                    <h3>⏰ Time Pressure</h3>
                    <p>You have <strong>10 seconds</strong> to decide what to do with each piece of content. The timer resets after each action. If time runs out, the game ends.</p>
                    
                    <h3 style="margin-top: 20px;">📊 User Engagement</h3>
                    <p>Each user has specific interests (shown as colored tags). Content matching their interests gives <strong>+10 bonus engagement</strong>. Non-matching content gives much less.</p>
                    <p style="margin-top: 10px;"><strong>Exception:</strong> Politics, debate, and fake news are always engaging, regardless of user interests.</p>
                    
                    <h3 style="margin-top: 20px;">⚠️ Polarization</h3>
                    <p>Controversial content increases platform polarization. If it reaches <strong>100%</strong>, the platform becomes too divisive and the game ends.</p>
                </div>
                
                <button class="btn btn-large" onclick="showTutorialPage(1)">⬅️ Back</button>
                <button class="btn btn-large" onclick="showTutorialPage(3)">Next: Your Actions ➡️</button>
            </div>

            <div id="tutorial-page-3" class="hidden">
                <h2>🎮 Your Actions</h2>
                
                <div style="text-align: left; margin: 20px 0;">
                    <h3>👤 Promote to User</h3>
                    <p>Send content to a specific user's feed. They will see it and their engagement will increase based on how well it matches their interests.</p>
                    
                    <h3 style="margin-top: 20px;">🗑️ Discard</h3>
                    <p>Remove content from the queue entirely. Nobody sees it. However, discarding too much content (over 30%) creates <strong>omission bias</strong> - you're censoring information.</p>
                    
                    <h3 style="margin-top: 20px;">🎯 Win Condition</h3>
                    <p>Get <strong>ALL users to 100% engagement</strong> before the content queue runs out.</p>
                    
                    <h3 style="margin-top: 20px;">💥 Lose Conditions</h3>
                    <p>• Timer reaches 0 without action<br>• Polarization reaches 100%<br>• Content runs out with users below 100%</p>
                </div>
                
                <button class="btn btn-large" onclick="showTutorialPage(2)">⬅️ Back</button>
                <button class="btn btn-large" onclick="showTutorialPage(4)">Next: Strategy Tips ➡️</button>
            </div>

            <div id="tutorial-page-4" class="hidden">
                <h2>💡 Strategy Tips</h2>
                
                <div id="tutorial-tips" style="text-align: left; margin: 20px 0; line-height: 1.8;">
                    • <strong>Match content to user interests</strong> for maximum engagement<br><br>
                    • <strong>Balance polarizing content:</strong> Use it strategically, but watch the polarization meter<br><br>
                    • <strong>Don't discard too much:</strong> Over 30% creates omission bias alerts<br><br>
                    • <strong>Work quickly:</strong> You only have 10 seconds per decision<br><br>
                    • <strong>Focus strategically:</strong> Sometimes it's better to get one user to 100% quickly than spread content evenly
                </div>
                
                <button class="btn btn-large" onclick="showTutorialPage(3)">⬅️ Back</button>
                <button class="btn btn-large" onclick="startGame()">🚀 Start Game</button>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal hidden" id="game-over-modal">
        <div class="modal-content">
            <h2>💥 Game Over!</h2>
            <p id="game-over-message">The platform became too polarized and users left!</p>
            <div id="game-over-explanation" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: left; font-size: 0.9em;">
                <!-- Explanation will be inserted here -->
            </div>
            <button class="btn btn-large" onclick="restartGame()">🔄 Try Again</button>
            <button class="btn btn-large" onclick="backToTutorial()">📚 Back to Tutorial</button>
        </div>
    </div>

    <!-- Level Complete Modal -->
    <div class="modal hidden" id="level-complete-modal">
        <div class="modal-content">
            <h2>🎉 Level Complete!</h2>
            <p id="level-complete-message">Great job managing the algorithm!</p>
            <button class="btn btn-large" onclick="showBiasReport()">📊 View Report</button>
        </div>
    </div>

    <!-- Bias Report Modal -->
    <div class="modal hidden" id="bias-report-modal">
        <div class="modal-content">
            <h2>📊 Level Complete - Bias Report</h2>
            <div id="bias-report-content">
                <!-- Report content will be generated here -->
            </div>
            <div id="bias-education" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: left; font-size: 0.9em;">
                <!-- Educational content will be inserted here -->
            </div>
            <button class="btn btn-large" onclick="nextLevel()">➡️ Next Level</button>
        </div>
    </div>

    <!-- Level Announcement Modal -->
    <div class="modal hidden" id="level-announcement-modal">
        <div class="modal-content">
            <h2 id="announcement-title">🎯 Level 2</h2>
            <p id="announcement-description">New challenges await!</p>
            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3>📋 Level Details:</h3>
                <p id="announcement-users" style="font-size: 1.1em; margin: 10px 0;"></p>
                <p id="announcement-content" style="font-size: 1.1em; margin: 10px 0;"></p>
                <p style="margin-top: 15px; opacity: 0.9;">Remember: 10 seconds per decision, timer resets after each action!</p>
            </div>
            <button class="btn btn-large" onclick="closeAnnouncementAndStart()">🚀 Start Level</button>
        </div>
    </div>

    <script>
        // Sound System using Web Audio API
        const AudioSystem = {
            context: null,
            
            init() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
            },
            
            // Button click sound - soft UI click
            playButtonClick() {
                if(!this.context) this.init();
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.1);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.1);
            },
            
            // Engagement increase sound - rising frequency based on engagement level
            playEngagementSound(engagementLevel) {
                if(!this.context) this.init();
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                // Map engagement (0-100) to frequency (300-800 Hz) with exponential curve
                const normalizedEngagement = Math.min(engagementLevel / 100, 1);
                const startFreq = 300 + (normalizedEngagement * normalizedEngagement * 500); // Quadratic curve
                const endFreq = startFreq + 100;
                
                oscillator.frequency.setValueAtTime(startFreq, this.context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(endFreq, this.context.currentTime + 0.3);
                oscillator.type = 'sine';
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, this.context.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, this.context.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.3);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.3);
            },
            
            // Success sound for level completion
            playSuccessSound() {
                if(!
this.context) this.init();
                
                // Play a pleasant chord
                const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
                
                frequencies.forEach((freq, index) => {
                    const oscillator = this.context.createOscillator();
                    const gainNode = this.context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.context.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    const startTime = this.context.currentTime + (index * 0.1);
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(0.15, startTime + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.6);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + 0.6);
                });
            },
            
            // Warning sound for polarization
            playWarningSound() {
                if(!this.context) this.init();
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.value = 220;
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.2, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.2);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.2);
            }
        };
        
        // Phase 2: Core Game Logic Implementation
        
        // Game State Management
        let gameState = {
            currentLevel: 1,
            timer: 10,
            timerInterval: null,
            globalPolarization: 0,
            totalEngagement: 0,
            contentProcessed: 0,
            contentDiscarded: 0,
            users: [],
            contentQueue: [],
            currentContentIndex: 0,
            biasAlerts: [],
            roundSummary: [],
            lossCount: 0,
            levelDescriptions: {
                1: "Learn how content algorithms work by managing one user's feed.",
                2: "Balance multiple users with different interests and demographics.",
                3: "Master the algorithm with complex user dynamics and diverse content."
            }
        };

        // Data Generation - User Pool
        const userPool = [
            {
                name: "Alex Chen", age: 22, location: "San Francisco", education: "College",
                interests: ["technology", "sports", "entertainment"],
                engagement: 0, contentHistory: []
            },
            {
                name: "Maria Rodriguez", age: 34, location: "Austin", education: "Graduate",
                interests: ["politics", "news", "health"],
                engagement: 0, contentHistory: []
            },
            {
                name: "David Kim", age: 28, location: "Seattle", education: "College",
                interests: ["lifestyle", "entertainment", "technology"],
                engagement: 0, contentHistory: []
            },
            {
                name: "Sarah Johnson", age: 45, location: "Chicago", education: "High School",
                interests: ["health", "lifestyle", "news"],
                engagement: 0, contentHistory: []
            },
            {
                name: "Michael Brown", age: 31, location: "Denver", education: "Graduate",
                interests: ["sports", "politics", "technology"],
                engagement: 0, contentHistory: []
            },
            {
                name: "Emma Wilson", age: 26, location: "Portland", education: "College",
                interests: ["entertainment", "lifestyle", "health"],
                engagement: 0, contentHistory: []
            },
            {
                name: "James Davis", age: 38, location: "Miami", education: "College",
                interests: ["sports", "news", "entertainment"],
                engagement: 0, contentHistory: []
            },
            {
                name: "Lisa Anderson", age: 29, location: "Boston", education: "Graduate",
                interests: ["technology", "politics", "health"],
                engagement: 0, contentHistory: []
            },
            {
                name: "Carlos Martinez", age: 33, location: "Phoenix", education: "High School",
                interests: ["lifestyle", "sports", "entertainment"],
                engagement: 0, contentHistory: []
            },
            {
                name: "Amanda Taylor", age: 24, location: "Nashville", education: "College",
                interests: ["entertainment", "lifestyle", "technology"],
                engagement: 0, contentHistory: []
            }
        ];

        // Data Generation - Content Pool
        const contentPool = {
            sports: [
                { title: "🏈 NFL Season Highlights", description: "Amazing touchdown compilations", engagement: 20, polarization: 2 },
                { title: "⚽ World Cup Analysis", description: "Expert predictions and team stats", engagement: 25, polarization: 3 },
                { title: "🏀 NBA Trade News", description: "Latest player movements", engagement: 18, polarization: 1 },
                { title: "🎾 Tennis Championship", description: "Wimbledon finals coverage", engagement: 15, polarization: 1 },
                { title: "🏊 Olympic Swimming Records", description: "New world records broken", engagement: 22, polarization: 2 }
            ],
            entertainment: [
                { title: "🎬 New Movie Trailers", description: "Blockbuster previews and reviews", engagement: 30, polarization: 1 },
                { title: "🎵 Music Festival Lineup", description: "This year's biggest acts", engagement: 28, polarization: 2 },
                { title: "📺 TV Show Finale", description: "Epic season endings discussed", engagement: 26, polarization: 3 },
                { title: "🎭 Celebrity Interviews", description: "Behind the scenes stories", engagement: 24, polarization: 2 },
                { title: "🎮 Gaming News", description: "Latest video game releases", engagement: 22, polarization: 1 }
            ],
            lifestyle: [
                { title: "🏠 Home Decoration Tips", description: "Transform your living space", engagement: 18, polarization: 1 },
                { title: "👗 Fashion Trends", description: "This season's hottest looks", engagement: 20, polarization: 2 },
                { title: "🍳 Easy Recipe Ideas", description: "Quick meals for busy people", engagement: 25, polarization: 1 },
                { title: "✈️ Travel Destinations", description: "Hidden gems around the world", engagement: 28, polarization: 2 },
                { title: "💄 Beauty Tutorials", description: "Professional makeup tips", engagement: 22, polarization: 1 }
            ],
            health: [
                { title: "💪 Fitness Routines", description: "Effective workout plans", engagement: 24, polarization: 2 },
                { title: "🥗 Nutrition Guide", description: "Healthy eating made simple", engagement: 26, polarization: 3 },
                { title: "🧘 Mental Health Tips", description: "Stress management techniques", engagement: 28, polarization: 1 },
                { title: "💊 Medical Breakthroughs", description: "Latest research findings", engagement: 20, polarization: 4 },
                { title: "🏃 Running Marathon Training", description: "Prepare for your first race", engagement: 18, polarization: 2 }
            ],
            technology: [
                { title: "📱 New Smartphone Features", description: "Latest mobile innovations", engagement: 32, polarization: 2 },
                { title: "🤖 AI Development News", description: "Breakthrough in artificial intelligence", engagement: 30, polarization: 5 },
                { title: "🚗 Electric Car Reviews", description: "Sustainable transportation options", engagement: 28, polarization: 8 },
                { title: "💻 Software Updates", description: "New features and security patches", engagement: 20, polarization: 1 },
                { title: "🌐 Internet Privacy", description: "Protecting your digital footprint", engagement: 26, polarization: 6 }
            ],
            news: [
                { title: "🌍 Global Climate Report", description: "Environmental impact studies", engagement: 24, polarization: 12 },
                { title: "💼 Economic Updates", description: "Market trends and analysis", engagement: 22, polarization: 8 },
                { title: "🏛️ Local Government News", description: "City council decisions", engagement: 18, polarization: 6 },
                { title: "🎓 Education Reform", description: "Changes in school systems", engagement: 20, polarization: 10 },
                { title: "🚨 Breaking News Alert", description: "Important current events", engagement: 35, polarization: 15 }
            ],
            politics: [
                { title: "🗳️ Election Coverage", description: "Candidate platforms and debates", engagement: 45, polarization: 35 },
                { title: "📜 Policy Analysis", description: "New legislation breakdown", engagement: 40, polarization: 30 },
                { title: "🏛️ Congressional Updates", description: "Latest voting results", engagement: 38, polarization: 28 },
                { title: "🌍 International Relations", description: "Diplomatic developments", engagement: 42, polarization: 32 },
                { title: "💰 Budget Discussions", description: "Government spending priorities", engagement: 35, polarization: 25 }
            ],
            debate: [
                { title: "🔥 Immigration Policy Debate", description: "Heated discussions on border control", engagement: 50, polarization: 45 },
                { title: "⚖️ Constitutional Rights", description: "Interpreting fundamental freedoms", engagement: 48, polarization: 42 },
                { title: "🏥 Healthcare System", description: "Public vs private healthcare", engagement: 46, polarization: 40 },
                { title: "🌱 Climate Action Debate", description: "Environmental policy arguments", engagement: 44, polarization: 38 },
                { title: "💼 Taxation Discussion", description: "Who should pay more?", engagement: 42, polarization: 36 }
            ],
            fakenews: [
                { title: "👽 Aliens Among Us", description: "Government cover-up exposed!", engagement: 60, polarization: 50 },
                { title: "💉 Vaccine Conspiracy", description: "Hidden dangers revealed", engagement: 55, polarization: 48 },
                { title: "🌍 Flat Earth Evidence", description: "Scientists don't want you to know", engagement: 52, polarization: 46 },
                { title: "🏛️ Election Fraud Claims", description: "Proof of stolen votes", engagement: 65, polarization: 55 },
                { title: "📡 5G Mind Control", description: "Technology controlling thoughts", engagement: 58, polarization: 52 }
            ]
        };

        // Core Gameplay Functions
        function startGame() {
            AudioSystem.playButtonClick();
            document.getElementById('tutorial-modal').classList.add('hidden');
            gameState = {
                currentLevel: 1,
                timer: 10,
                timerInterval: null,
                globalPolarization: 0,
                totalEngagement: 0,
                contentProcessed: 0,
                contentDiscarded: 0,
                users: [],
                contentQueue: [],
                currentContentIndex: 0,
                biasAlerts: [],
                roundSummary: [],
                lossCount: gameState.lossCount, // Preserve loss count
                levelDescriptions: gameState.levelDescriptions
            };
            showLevelAnnouncement();
        }

        function showLevelAnnouncement() {
            const level = gameState.currentLevel;
            let userCount, contentCount;
            
            switch(level) {
                case 1: userCount = 1; contentCount = 10; break;
                case 2: userCount = 3; contentCount = 20; break;
                case 3: userCount = 5; contentCount = 25; break;
                default: userCount = 1; contentCount = 10;
            }
            
            document.getElementById('announcement-title').textContent = `🎯 Level ${level}`;
            document.getElementById('announcement-description').textContent = gameState.levelDescriptions[level];
            document.getElementById('announcement-users').innerHTML = `<strong>👥 Users:</strong> ${userCount} user${userCount > 1 ? 's' : ''} to manage`;
            document.getElementById('announcement-content').innerHTML = `<strong>📱 Content:</strong> ${contentCount} posts in the queue`;
            
            document.getElementById('level-announcement-modal').classList.remove('hidden');
        }

        function closeAnnouncementAndStart() {
            AudioSystem.playButtonClick();
            document.getElementById('level-announcement-modal').classList.add('hidden');
            initializeLevel();
            startTimer();
        }

        function initializeLevel() {
            const level = gameState.currentLevel;
            let userCount, contentCount;
            
            // Set user and content counts based on level
            switch(level) {
                case 1: userCount = 1; contentCount = 10; break;
                case 2: userCount = 3; contentCount = 20; break;
                case 3: userCount = 5; contentCount = 25; break;
                default: userCount = 1; contentCount = 10;
            }
            
            // Reset and select random users
            gameState.users = [];
            const shuffledUsers = [...userPool].sort(() => Math.random() - 0.5);
            for(let i = 0; i < userCount; i++) {
                const user = {...shuffledUsers[i]};
                user.engagement = 0;
                user.contentHistory = [];
                gameState.users.push(user);
            }
            
            // Generate content queue
            gameState.contentQueue = generateContentQueue(contentCount);
            gameState.currentContentIndex = 0;
            
            // Ensure polarization starts at 0 for new level
            gameState.globalPolarization = 0;
            
            updateDisplay();
        }

        function generateContentQueue(count) {
            const queue = [];
            const categories = Object.keys(contentPool);
            let lastCategory = null;
            
            // Collect all user interests
            const userInterests = new Set();
            gameState.users.forEach(user => {
                user.interests.forEach(interest => userInterests.add(interest));
            });
            
            // Convert to array for easier manipulation
            const interestArray = Array.from(userInterests);
            
            // Always include controversial categories
            const controversialCategories = ['politics', 'debate', 'fakenews'];
            
            // Calculate content distribution
            // 60% matching interests, 20% controversial, 20% random non-matching
            const matchingCount = Math.floor(count * 0.6);
            const controversialCount = Math.floor(count * 0.2);
            const randomCount = count - matchingCount - controversialCount;
            
            // Build a pool of categories to use
            const categoryPool = [];
            
            // Add matching interests
            for(let i = 0; i < matchingCount; i++) {
                if(interestArray.length > 0) {
                    categoryPool.push(interestArray[Math.floor(Math.random() * interestArray.length)]);
                } else {
                    // Fallback if no interests
                    categoryPool.push(categories[Math.floor(Math.random() * categories.length)]);
                }
            }
            
            // Add controversial content
            for(let i = 0; i < controversialCount; i++) {
                categoryPool.push(controversialCategories[Math.floor(Math.random() * controversialCategories.length)]);
            }
            
            // Add random non-matching content
            const nonMatchingCategories = categories.filter(cat => 
                !interestArray.includes(cat) && !controversialCategories.includes(cat)
            );
            for(let i = 0; i < randomCount; i++) {
                if(nonMatchingCategories.length > 0) {
                    categoryPool.push(nonMatchingCategories[Math.floor(Math.random() * nonMatchingCategories.length)]);
                } else {
                    // Fallback to any category
                    categoryPool.push(categories[Math.floor(Math.random() * categories.length)]);
                }
            }
            
            // Shuffle the category pool
            for(let i = categoryPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [categoryPool[i], categoryPool[j]] = [categoryPool[j], categoryPool[i]];
            }
            
            // Generate content ensuring no consecutive duplicates
            for(let i = 0; i < count; i++) {
                let category;
                
                // If this would create a duplicate, swap with a different category from remaining pool
                if(categoryPool[i] === lastCategory) {
                    // Find a different category in the remaining pool
                    let swapIndex = i + 1;
                    while(swapIndex < categoryPool.length && categoryPool[swapIndex] === lastCategory) {
                        swapIndex++;
                    }
                    
                    if(swapIndex < categoryPool.length) {
                        // Swap with a different category
                        [categoryPool[i], categoryPool[swapIndex]] = [categoryPool[swapIndex], categoryPool[i]];
                    } else {
                        // Fallback: pick any different category
                        const availableCategories = categories.filter(cat => cat !== lastCategory);
                        categoryPool[i] = availableCategories[Math.floor(Math.random() * availableCategories.length)];
                    }
                }
                
                category = categoryPool[i];
                const categoryContent = contentPool[category];
                const content = {...categoryContent[Math.floor(Math.random() * categoryContent.length)]};
                content.category = category;
                content.id = Date.now() + Math.random() + i; // Ensure unique IDs
                queue.push(content);
                
                lastCategory = category;
            }
            
            return queue;
        }

        function updateDisplay() {
            // Update level info in header
            document.getElementById('header-level').textContent = `Level ${gameState.currentLevel}`;
            
            // Update level info section
            document.getElementById('level-title').textContent = `Level ${gameState.currentLevel}: ${gameState.currentLevel === 1 ? 'Basic Concept' : gameState.currentLevel === 2 ? 'Multiple Users' : 'Advanced Algorithm'}`;
            document.getElementById('level-description').textContent = gameState.levelDescriptions[gameState.currentLevel];
            
            // Update stats
            document.getElementById('content-processed').textContent = gameState.contentProcessed;
            document.getElementById('content-discarded').textContent = gameState.contentDiscarded;
            document.getElementById('discard-count').textContent = gameState.contentDiscarded;
            
            // Update content queue counter
            const contentRemaining = gameState.contentQueue.length - gameState.currentContentIndex;
            document.getElementById('content-remaining').textContent = contentRemaining;
            document.getElementById('content-total').textContent = gameState.contentQueue.length;
            
            // Update polarization meter
            const polarizationPercent = Math.max(0, Math.min(gameState.globalPolarization, 100));
            const polarizationFill = document.getElementById('polarization-fill');
            const polarizationText = document.getElementById('polarization-text');
            
            polarizationFill.style.width = polarizationPercent + '%';
            polarizationText.textContent = Math.round(polarizationPercent) + '%';
            
            // Remove any existing animations first
            polarizationFill.style.animation = 'none';
            
            if(polarizationPercent >= 60) {
                polarizationFill.style.animation = 'pulse 1s infinite';
            } else if(polarizationPercent === 0) {
                // Ensure clean visual state for zero polarization
                polarizationFill.style.backgroundColor = '';
            }
            
            // Update users
            updateUserDisplay();
            
            // Update content
            updateContentDisplay();
            
            // Update round summary
            updateRoundSummary();
        }

        function showTutorialPage(pageNum) {
            AudioSystem.playButtonClick();
            // Hide all pages
            for(let i = 1; i <= 4; i++) {
                document.getElementById(`tutorial-page-${i}`).classList.add('hidden');
            }
            // Show requested page
            document.getElementById(`tutorial-page-${pageNum}`).classList.remove('hidden');
        }

        function updateUserDisplay() {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            
            gameState.users.forEach((user, index) => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                // Create interest tags with matching colors
                const interestTags = user.interests.map(interest => 
                    `<span class="interest-tag interest-${interest}">${interest}</span>`
                ).join('');
                
                userCard.innerHTML = `
                    <div class="user-name">${user.name}</div>
                    <div class="user-info">
                        ${user.age}y, ${user.location}<br>
                        Education: ${user.education}
                    </div>
                    <div class="user-interests">
                        ${interestTags}
                    </div>
                    <div class="engagement-bar-container">
                        <div class="engagement-label">Engagement: ${Math.round(user.engagement)}%</div>
                        <div class="engagement-bar">
                            <div class="engagement-fill" style="width: ${Math.min(user.engagement, 100)}%"></div>
                        </div>
                    </div>
                `;
                userList.appendChild(userCard);
            });
        }

        function updateContentDisplay() {
            const contentContainer = document.getElementById('content-container');
            
            if(gameState.currentContentIndex >= gameState.contentQueue.length) {
                contentContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p>🔭 No more content in queue.</p>
                        <button class="btn btn-large" onclick="checkWinCondition()">⭐ Check Results</button>
                    </div>
                `;
                return;
            }
            
            const content = gameState.contentQueue[gameState.currentContentIndex];
            contentContainer.innerHTML = `
                <div class="content-card">
                    <div class="content-tag tag-${content.category}">${content.category.toUpperCase()}</div>
                    <div class="content-title">${content.title}</div>
                    <div class="content-description">${content.description}</div>
                    <div class="content-stats">
                        <div class="stat-item">📈 +${content.engagement} engagement</div>
                        <div class="stat-item">⚡ +${content.polarization} polarization</div>
                    </div>
                    <div class="action-buttons">
                        <div class="user-specific-buttons">
                            ${gameState.users.map((user, index) => 
                                `<button class="btn" onclick="promoteToUser(${index})">👤 Promote to ${user.name}</button>`
                            ).join('')}
                        </div>
                        <button class="btn btn-discard" onclick="discardContent()">🗑️ Discard Content</button>
                    </div>
                </div>
            `;
        }

        function updateRoundSummary() {
            const summary = document.getElementById('round-summary');
            if(gameState.roundSummary.length === 0) {
                summary.textContent = "Game in progress...";
                return;
            }
            
            summary.innerHTML = gameState.roundSummary.slice(-10).map(entry => 
                `<div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                    ${entry}
                </div>`
            ).join('');
        }

        function deliverContent(content, targetUsers) {
            gameState.contentProcessed++;
            let totalEngagementGain = 0;
            let totalPolarizationGain = 0;
            
            targetUsers.forEach(user => {
                let engagementBoost = content.engagement;
                
                // Special handling for politics, debate, and fake news - no penalty for non-matching interests
                if(['politics', 'debate', 'fakenews'].includes(content.category)) {
                    // These categories always provide full engagement regardless of user interests
                    if(user.interests.includes(content.category)) {
                        engagementBoost += 10; // Still give bonus for matching interest
                    }
                    // No penalty applied for non-matching interests
                } else {
                    // Original logic for other content types
                    if(user.interests.includes(content.category)) {
                        engagementBoost += 10; // Bonus remains the same
                    } else {
                        // Severe penalty: cap at maximum 5% engagement for non-matching content
                        engagementBoost = Math.min(engagementBoost - 15, 5);
                    }
                }
                
                // Ensure minimum engagement gain is still positive
                engagementBoost = Math.max(engagementBoost, 1);
                
                user.engagement += engagementBoost;
                user.contentHistory.push(content);
                
                // Play engagement sound based on user's current engagement level
                AudioSystem.playEngagementSound(user.engagement);
                
                totalEngagementGain += engagementBoost;
                totalPolarizationGain += content.polarization;
                
                gameState.roundSummary.push(`${user.name} received "${content.title}" (+${engagementBoost} engagement)`);
            });
            
            gameState.totalEngagement += totalEngagementGain;
            gameState.globalPolarization += totalPolarizationGain;
            gameState.currentContentIndex++;
            
            // Play warning sound if polarization is high
            if(gameState.globalPolarization >= 60 && gameState.globalPolarization < 100) {
                AudioSystem.playWarningSound();
            }
            
            // Check for immediate game over from polarization BEFORE resetting timer
            if(gameState.globalPolarization >= 100) {
                clearInterval(gameState.timerInterval);
                updateDisplay();
                setTimeout(() => {
                    showGameOver("🚨 PLATFORM CRISIS: Polarization reached 100%! The platform has become too divisive and users are leaving.");
                }, 500);
                return; // Exit early to prevent timer reset and other checks
            }
            
            // Reset timer after content delivery (only if game not over)
            resetTimer();
            
            // Check for bias patterns
            checkBiasPatterns();
            
            updateDisplay();
            
            // Check for immediate win condition - changed to 100%
            const allUsersEngaged = gameState.users.every(user => user.engagement >= 100);
            if(allUsersEngaged) {
                setTimeout(() => {
                    clearInterval(gameState.timerInterval);
                    showLevelComplete();
                }, 500);
            }
        }

        function startTimer() {
            // Clear any existing timer first
            if(gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            gameState.timer = 10;
            updateTimerDisplay();
            
            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                updateTimerDisplay();
                
                if(gameState.timer <= 0) {
                    clearInterval(gameState.timerInterval);
                    gameState.timerInterval = null;
                    showGameOver("⏰ TIME'S UP! You didn't make a decision in time. The algorithm needs constant attention!");
                }
            }, 1000);
        }

        function resetTimer() {
            // Clear the existing timer
            if(gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            // Reset to 10 seconds and start new timer
            gameState.timer = 10;
            updateTimerDisplay();
            
            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                updateTimerDisplay();
                
                if(gameState.timer <= 0) {
                    clearInterval(gameState.timerInterval);
                    gameState.timerInterval = null;
                    showGameOver("⏰ TIME'S UP! You didn't make a decision in time. The algorithm needs constant attention!");
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById('timer');
            const gameContainer = document.getElementById('game-container');
            
            timerElement.textContent = `⏰ 0:${gameState.timer.toString().padStart(2, '0')}`;
            
            if(gameState.timer <= 3) {
                timerElement.classList.add('critical');
                gameContainer.classList.add('critical-time');
            } else {
                timerElement.classList.remove('critical');
                gameContainer.classList.remove('critical-time');
            }
        }

        function checkBiasPatterns() {
            // Reset bias alerts for this check
            const currentAlerts = [];
            
            gameState.users.forEach(user => {
                // Echo Chamber: 3+ posts from same category
                const categoryCount = {};
                user.contentHistory.forEach(content => {
                    categoryCount[content.category] = (categoryCount[content.category] || 0) + 1;
                });
                
                Object.entries(categoryCount).forEach(([category, count]) => {
                    if(count >= 3) {
                        currentAlerts.push(`Echo Chamber: ${user.name} in ${category.toUpperCase()}`);
                    }
                });
                
                // Filter Bubble: Last 3 items match interests
                if(user.contentHistory.length >= 3) {
                    const lastThree = user.contentHistory.slice(-3);
                    const allMatch = lastThree.every(content => user.interests.includes(content.category));
                    if(allMatch) {
                        currentAlerts.push(`Filter Bubble: ${user.name} seeing only interests`);
                    }
                }
                
                // Misinformation: 2+ fake news items
                const fakeNewsCount = user.contentHistory.filter(content => content.category === 'fakenews').length;
                if(fakeNewsCount >= 2) {
                    currentAlerts.push(`Misinformation: ${user.name} exposed to fake news`);
                }
            });
            
            // Omission Bias: >30% content discarded
            if(gameState.contentProcessed + gameState.contentDiscarded > 0) {
                const discardRate = gameState.contentDiscarded / (gameState.contentProcessed + gameState.contentDiscarded);
                if(discardRate > 0.3) {
                    currentAlerts.push(`Omission Bias: ${Math.round(discardRate * 100)}% content discarded`);
                }
            }
            
            gameState.biasAlerts = currentAlerts;
            updateBiasDisplay();
        }

        function updateBiasDisplay() {
            const alertsContainer = document.getElementById('bias-alerts-container');
            if(gameState.biasAlerts.length === 0) {
                alertsContainer.innerHTML =
'<div style="opacity: 0.6;">No bias detected yet...</div>';
                return;
            }
            
            alertsContainer.innerHTML = gameState.biasAlerts.map(alert => {
                const isWarning = alert.includes('Echo Chamber') || alert.includes('Misinformation');
                return `<div class="bias-alert ${isWarning ? 'warning' : ''}">${alert}</div>`;
            }).join('');
        }

        // Action Functions
        function promoteToUser(userIndex) {
            AudioSystem.playButtonClick();
            const content = gameState.contentQueue[gameState.currentContentIndex];
            const user = gameState.users[userIndex];
            deliverContent(content, [user]);
        }

        function discardContent() {
            AudioSystem.playButtonClick();
            const content = gameState.contentQueue[gameState.currentContentIndex];
            gameState.contentDiscarded++;
            gameState.currentContentIndex++;
            gameState.roundSummary.push(`🗑️ Discarded: "${content.title}"`);
            
            // Reset timer after discarding content
            resetTimer();
            
            updateDisplay();
        }

        // Win/Loss Condition Functions
        function checkWinCondition() {
            AudioSystem.playButtonClick();
            clearInterval(gameState.timerInterval);
            
            // Check if all users have >= 100% engagement
            const allUsersEngaged = gameState.users.every(user => user.engagement >= 100);
            
            if(allUsersEngaged) {
                showLevelComplete();
            } else {
                const avgEngagement = gameState.users.reduce((sum, user) => sum + user.engagement, 0) / gameState.users.length;
                const unengagedUsers = gameState.users.filter(user => user.engagement < 100);
                showGameOver(`📋 CONTENT COMPLETE! ${unengagedUsers.length} user(s) didn't reach 100% engagement. Average engagement: ${Math.round(avgEngagement)}%.`);
            }
        }

        function showGameOver(message) {
            gameState.lossCount++;
            document.getElementById('game-over-message').textContent = message;
            
            // Add educational explanation based on failure reason
            const explanationDiv = document.getElementById('game-over-explanation');
            let explanation = '';
            
            if(message.includes('Polarization')) {
                explanation = `
                    <h4>📚 Understanding Polarization:</h4>
                    <p><strong>What is it?</strong> Polarization occurs when users are exposed to extreme, divisive content that reinforces opposing viewpoints and creates "echo chambers."</p>
                    
                    <p><strong>Legal Risks:</strong> Platforms face lawsuits for amplifying harmful content, spreading misinformation, and contributing to social division. Regulators in the EU, US, and other regions are creating laws requiring platforms to moderate polarizing content.</p>
                    
                    <p><strong>Platform Response:</strong> Real platforms use content moderation teams, AI detection systems, and "circuit breakers" that slow the spread of viral polarizing content. They balance free speech with harm prevention.</p>
                    
                    <p><strong>The Challenge:</strong> Polarizing content is highly engaging (more clicks, shares, time spent), creating a conflict between business goals and social responsibility.</p>
                `;
            } else if(message.includes("TIME'S UP")) {
                explanation = `
                    <h4>⏰ The Speed Challenge:</h4>
                    <p>Real content algorithms make millions of decisions per second. While you have 10 seconds per choice, actual platforms must instantly decide what to show each user as they scroll.</p>
                    
                    <p>This speed requirement makes it difficult to carefully consider ethical implications, leading platforms to optimize primarily for engagement metrics rather than social good.</p>
                `;
            } else {
                explanation = `
                    <h4>📊 Engagement Challenge:</h4>
                    <p>You didn't get all users to 100% engagement. In the real world, platforms constantly struggle to keep ALL users engaged across diverse demographics and interests.</p>
                    
                    <p>The algorithm must balance showing users what they like (easy engagement) with introducing diverse content (harder but healthier for society).</p>
                `;
            }
            
            explanationDiv.innerHTML = explanation;
            
            // Update tutorial tips after 2+ losses
            if(gameState.lossCount >= 2) {
                updateTutorialTips();
            }
            
            document.getElementById('game-over-modal').classList.remove('hidden');
        }

        function updateTutorialTips() {
            const tipsElement = document.getElementById('tutorial-tips');
            tipsElement.innerHTML = `
                <strong style="color: #FFD700;">💡 Having trouble? Here are advanced tips:</strong><br>
                • <strong>Prioritize matching interests:</strong> Non-matching content gives very little engagement<br>
                • <strong>Politics/debate/fake news are powerful:</strong> They engage everyone but raise polarization fast<br>
                • <strong>Use controversial content strategically:</strong> When users are close to 100%, a boost from politics can finish them<br>
                • <strong>Don't discard too much:</strong> Over 30% discard rate triggers omission bias alerts<br>
                • <strong>Work systematically:</strong> Focus on one user at a time to get them to 100% quickly<br>
                • <strong>Watch the clock:</strong> Don't overthink - you have 10 seconds per decision!
            `;
        }

        function backToTutorial() {
            AudioSystem.playButtonClick();
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('tutorial-modal').classList.remove('hidden');
        }

        function showLevelComplete() {
            AudioSystem.playSuccessSound();
            const avgEngagement = gameState.users.reduce((sum, user) => sum + user.engagement, 0) / gameState.users.length;
            document.getElementById('level-complete-message').textContent = 
                `Level ${gameState.currentLevel} completed! All users reached 100% engagement. Average: ${Math.round(avgEngagement)}%, Polarization: ${Math.round(gameState.globalPolarization)}%.`;
            document.getElementById('level-complete-modal').classList.remove('hidden');
        }

        function restartGame() {
            AudioSystem.playButtonClick();
            document.getElementById('game-over-modal').classList.add('hidden');
            // Reset to level 1 but keep loss count
            const currentLossCount = gameState.lossCount;
            gameState = {
                currentLevel: 1,
                timer: 10,
                timerInterval: null,
                globalPolarization: 0,
                totalEngagement: 0,
                contentProcessed: 0,
                contentDiscarded: 0,
                users: [],
                contentQueue: [],
                currentContentIndex: 0,
                biasAlerts: [],
                roundSummary: [],
                lossCount: currentLossCount,
                levelDescriptions: gameState.levelDescriptions
            };
            showLevelAnnouncement();
        }

        function showBiasReport() {
            AudioSystem.playButtonClick();
            document.getElementById('level-complete-modal').classList.add('hidden');
            generateBiasReport();
            document.getElementById('bias-report-modal').classList.remove('hidden');
        }

        function generateBiasReport() {
            const reportContent = document.getElementById('bias-report-content');
            const avgEngagement = gameState.users.reduce((sum, user) => sum + user.engagement, 0) / gameState.users.length;
            
            reportContent.innerHTML = `
                <div style="text-align: left; margin: 20px 0;">
                    <h3>📊 Performance Metrics</h3>
                    <p><strong>Final Polarization:</strong> ${Math.round(gameState.globalPolarization)}%</p>
                    <p><strong>Average Engagement:</strong> ${Math.round(avgEngagement)}%</p>
                    <p><strong>Content Processed:</strong> ${gameState.contentProcessed}</p>
                    <p><strong>Content Discarded:</strong> ${gameState.contentDiscarded}</p>
                    
                    <h3>🚨 Bias Detection</h3>
                    ${gameState.biasAlerts.length > 0 ? 
                        gameState.biasAlerts.map(alert => `<p>• ${alert}</p>`).join('') : 
                        '<p>No significant bias patterns detected.</p>'
                    }
                </div>
            `;
            
            // Add educational content based on detected biases and level
            const biasEducation = document.getElementById('bias-education');
            biasEducation.innerHTML = getBiasEducation();
        }

        function getBiasEducation() {
            let education = '';
            
            // Detect which biases were actually triggered
            const hasEchoChamber = gameState.biasAlerts.some(alert => alert.includes('Echo Chamber'));
            const hasFilterBubble = gameState.biasAlerts.some(alert => alert.includes('Filter Bubble'));
            const hasMisinformation = gameState.biasAlerts.some(alert => alert.includes('Misinformation'));
            const hasOmissionBias = gameState.biasAlerts.some(alert => alert.includes('Omission Bias'));
            
            // Check if fake news was used
            const fakeNewsUsed = gameState.users.some(user => 
                user.contentHistory.some(content => content.category === 'fakenews')
            );
            
            // Add level-specific introduction
            if(gameState.currentLevel === 1) {
                education += `<h4>📚 Understanding Algorithmic Bias - Level 1:</h4>`;
            } else if(gameState.currentLevel === 2) {
                education += `<h4>📚 Understanding Algorithmic Bias - Level 2:</h4>`;
            } else {
                education += `<h4>📚 Understanding Algorithmic Bias - Level 3:</h4>`;
            }
            
            // Only include explanations for biases that were detected
            if(hasEchoChamber) {
                education += `
                    <p><strong>🔄 Echo Chamber Detected:</strong> You showed users the same type of content repeatedly. Echo chambers occur when algorithms reinforce existing beliefs by showing similar content over and over. This narrows users' worldviews and makes them less tolerant of different perspectives.</p>
                    
                    <p><strong>Real Impact:</strong> Echo chambers contribute to political polarization and make it difficult for people to understand different viewpoints. Users become convinced everyone thinks like them.</p>
                `;
            }
            
            if(hasFilterBubble) {
                education += `
                    <p><strong>🫧 Filter Bubble Detected:</strong> Users only saw content matching their interests. Filter bubbles create personalized realities where different users see completely different information on the same platform.</p>
                    
                    <p><strong>Real Impact:</strong> When people operate from different information sets, society struggles to agree on basic facts. Productive dialogue becomes nearly impossible when everyone lives in their own curated reality.</p>
                `;
            }
            
            if(hasMisinformation) {
                education += `
                    <p><strong>❌ Misinformation Exposure Detected:</strong> Users were exposed to multiple pieces of fake news. Repeated exposure to false information makes people more likely to believe it, even when fact-checked.</p>
                    
                    <p><strong>Real Impact:</strong> Misinformation spreads faster than truth because it's designed to provoke emotional reactions. This undermines public trust in legitimate institutions and creates confusion about reality.</p>
                `;
            }
            
            if(hasOmissionBias) {
                education += `
                    <p><strong>🚫 Omission Bias Detected:</strong> You discarded over 30% of content. What algorithms choose NOT to show is as important as what they show. Heavy content filtering creates incomplete worldviews.</p>
                    
                    <p><strong>Real Impact:</strong> When platforms filter too aggressively, users miss important information and perspectives. This form of censorship can be invisible to users who don't realize what they're not seeing.</p>
                `;
            }
            
            // Always include fake news section if it was used
            if(fakeNewsUsed) {
                education += `
                    <h4 style="margin-top: 20px;">⚠️ Fake News & Misinformation:</h4>
                    <p><strong>What Makes It Dangerous:</strong> Fake news is deliberately designed to mislead, often using emotional manipulation, false statistics, and conspiracy theories to spread rapidly.</p>
                    
                    <p><strong>Legal Risks for Platforms:</strong> Companies face lawsuits for amplifying harmful misinformation (especially health/election-related). The EU's Digital Services Act and similar regulations hold platforms accountable for viral false content.</p>
                    
                    <p><strong>How Companies Respond:</strong> Platforms use fact-checking partnerships, warning labels, reduced algorithmic amplification of unverified claims, and content moderation teams. However, balancing free speech with harm prevention remains controversial.</p>
                    
                    <p><strong>The Challenge:</strong> Fake news often gets more engagement than real news because it's more sensational. This creates a business incentive to allow it, conflicting with social responsibility.</p>
                `;
            }
            
            // Add general reflection if no specific biases detected
            if(!hasEchoChamber && !hasFilterBubble && !hasMisinformation && !hasOmissionBias) {
                education += `
                    <p>You managed to avoid major bias patterns this round! You balanced content diversity, kept users engaged, and maintained platform stability.</p>
                    
                    <p><strong>Key Lesson:</strong> Real platforms must constantly balance engagement (which drives revenue) with social responsibility (preventing harm). You experienced this tension firsthand.</p>
                `;
            }
            
            return education;
        }

        function getBiasReflection() {
            if(gameState.currentLevel === 1) {
                return "You've learned how content algorithms affect individual users. Notice how user interests influence engagement, and how certain content types increase both engagement and polarization.";
            } else if(gameState.currentLevel === 2) {
                return "With multiple users, you've seen how the same content affects different people. Algorithmic bias emerges when we optimize for engagement without considering diverse perspectives.";
            } else {
                return "You've experienced the full complexity of social media algorithms. The challenge of maintaining engagement while preventing echo chambers and misinformation spread reflects real-world platform dilemmas.";
            }
        }

        function nextLevel() {
            AudioSystem.playButtonClick();
            document.getElementById('bias-report-modal').classList.add('hidden');
            
            if(gameState.currentLevel >= 3) {
                AudioSystem.playSuccessSound();
                alert("🎉 Congratulations! You've completed all levels of The Feed Master! You now understand how social media algorithms work and their impact on users.");
                // Reset to tutorial with loss count preserved
                const currentLossCount = gameState.lossCount;
                gameState = {
                    currentLevel: 1,
                    timer: 10,
                    timerInterval: null,
                    globalPolarization: 0,
                    totalEngagement: 0,
                    contentProcessed: 0,
                    contentDiscarded: 0,
                    users: [],
                    contentQueue: [],
                    currentContentIndex: 0,
                    biasAlerts: [],
                    roundSummary: [],
                    lossCount: currentLossCount,
                    levelDescriptions: gameState.levelDescriptions
                };
                document.getElementById('tutorial-modal').classList.remove('hidden');
            } else {
                gameState.currentLevel++;
                
                // Reset all level-specific stats
                gameState.timer = 10;
                gameState.globalPolarization = 0; // Reset polarization to zero
                gameState.totalEngagement = 0;
                gameState.contentProcessed = 0;
                gameState.contentDiscarded = 0;
                gameState.biasAlerts = [];
                gameState.roundSummary = [];
                gameState.currentContentIndex = 0;
                
                // Clear any existing timer
                if(gameState.timerInterval) {
                    clearInterval(gameState.timerInterval);
                }
                
                showLevelAnnouncement();
            }
        }

        // Initialize bias display on load
        updateBiasDisplay();
        
        console.log("The Feed Master - Complete with Sound System");
    </script>
</body>
</html>